name: Build Arduino Nano Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify system info
      run: |
        echo "Running on $(uname -a)"
        echo "Current directory: $PWD"
        ls -lah

    - name: Install Arduino CLI
      run: |
        echo "Downloading Arduino CLI..."
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        # Add the CLI location inside the repo to PATH
        export PATH=$PATH:$GITHUB_WORKSPACE/bin
        echo "Arduino CLI version:"
        arduino-cli version
        which arduino-cli

    - name: Update Arduino cores
      run: |
        echo "Updating core index..."
        export PATH=$PATH:$GITHUB_WORKSPACE/bin
        arduino-cli core update-index || echo "Failed to update cores"

    - name: Install Arduino AVR core
      run: |
        echo "Installing arduino:avr core..."
        export PATH=$PATH:$GITHUB_WORKSPACE/bin
        arduino-cli core install arduino:avr || echo "Failed to install core"

    - name: Compile sketches
      run: |
        export PATH=$PATH:$GITHUB_WORKSPACE/bin
        mkdir -p site/firmware
        for sketch in $(find mod1 -name '*.ino' -type f); do
          sketch_dir=$(dirname "$sketch")
          
          # Get the author folder: first folder under mod1
          author_dir=$(echo "$sketch_dir" | sed -E 's|mod1/([^/]+)/.*|\1|')
          
          sketch_name=$(basename "$sketch" .ino)
          out_dir="site/firmware/tmp_build"
          mkdir -p "$out_dir"

          echo "Compiling $sketch_name from $author_dir..."
          arduino-cli compile --fqbn arduino:avr:nano:cpu=atmega328old "$sketch_dir" --output-dir "$out_dir" \
            || echo "WARNING: Failed to compile $sketch_name"

          # Find generated .hex file (Arduino CLI may name it differently)
          hex_file=$(find "$out_dir" -name "*.hex" | head -n 1)
          if [ -f "$hex_file" ]; then
            # Normalize filename: author_sketch.hex
            safe_name="${author_dir// /_}_${sketch_name// /_}.hex"
            cp "$hex_file" "site/firmware/$safe_name"
            echo "Copied as $safe_name"
          else
            echo "WARNING: No .hex file generated for $sketch_name"
          fi
        done

    - name: Generate firmware JSON
      run: |
        echo "[" > site/firmware.json
        first=true
        for file in site/firmware/*.hex; do
          [ -e "$file" ] || continue
          filename=$(basename "$file")
          # Split normalized name: author_sketch.hex
          author=$(echo "$filename" | cut -d'_' -f1)
          sketch=$(echo "$filename" | cut -d'_' -f2- | sed 's/\.hex$//')
          if [ "$first" = true ]; then
            first=false
          else
            echo "," >> site/firmware.json
          fi
          echo "  {\"author\": \"$author\", \"sketch\": \"$sketch\", \"file\": \"firmware/$filename\"}" >> site/firmware.json
        done
        echo "]" >> site/firmware.json
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        personal_token: ${{ secrets.PAT_TOKEN }}
        publish_dir: ./site
        publish_branch: gh-pages
